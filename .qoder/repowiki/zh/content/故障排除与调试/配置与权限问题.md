# 配置与权限问题

<cite>
**本文档引用的文件**   
- [MainActivity.kt](file://app/src/main/java/com/example/phonenet/MainActivity.kt)
- [SettingsActivity.kt](file://app/src/main/java/com/example/phonenet/SettingsActivity.kt)
- [FirewallVpnService.kt](file://app/src/main/java/com/example/phonenet/FirewallVpnService.kt)
- [MailJobIntentService.kt](file://app/src/main/java/com/example/phonenet/mail/MailJobIntentService.kt)
- [AndroidManifest.xml](file://app/src/main/AndroidManifest.xml)
- [strings.xml](file://app/src/main/res/values/strings.xml)
</cite>

## 目录
1. [PIN码保护机制](#pin码保护机制)
2. [通知权限的重要性](#通知权限的重要性)
3. [忽略电池优化设置](#忽略电池优化设置)
4. [查询所有应用权限](#查询所有应用权限)
5. [SMTP测试邮件配置](#smtp测试邮件配置)

## PIN码保护机制

应用通过PIN码机制保护设置页面的安全性。首次进入设置页面时，系统会提示用户创建PIN码。该PIN码用于验证用户身份，防止未经授权的设置更改。

当用户首次尝试访问设置页面时，若尚未设置PIN码，系统将弹出“设置PIN密码”对话框。用户需要输入至少4位数字的PIN码，并进行二次确认。若两次输入不一致或长度不足4位，系统将提示相应错误信息。

已设置PIN码后，每次进入设置页面均需输入正确的PIN码进行验证。在`MainActivity.kt`中，`showPinVerification()`方法负责处理PIN码验证逻辑。该方法检查是否存在已保存的PIN码，若存在则调用`showEnterPinDialog()`显示输入对话框。

若用户忘记PIN码，唯一的解决方案是清除应用数据或卸载后重新安装。此操作将导致所有现有配置丢失，需要重新设置。

**Section sources**
- [MainActivity.kt](file://app/src/main/java/com/example/phonenet/MainActivity.kt#L170-L202)
- [SettingsActivity.kt](file://app/src/main/java/com/example/phonenet/SettingsActivity.kt#L130-L181)

## 通知权限的重要性

在Android 13及以上系统中，应用必须获得`POST_NOTIFICATIONS`权限才能正常显示通知。对于本应用而言，该权限至关重要，因为它直接影响前台服务的稳定性。

`FirewallVpnService`服务需要在前台运行以确保网络管控功能的持续性。根据Android系统要求，前台服务必须显示一个持续的通知。如果缺少`POST_NOTIFICATIONS`权限，系统将不允许显示该通知，从而导致前台服务无法稳定运行，可能被系统终止。

在`MainActivity.kt`中，`attemptStartVpnService()`和`startVpn()`方法均包含对`POST_NOTIFICATIONS`权限的检查。当检测到Android 13+系统时，应用会主动请求该权限。若用户拒绝授权，VPN服务将无法启动。

此权限的获取是应用正常运行的必要条件之一，特别是在较新版本的Android系统上。

**Section sources**
- [MainActivity.kt](file://app/src/main/java/com/example/phonenet/MainActivity.kt#L82-L85)
- [FirewallVpnService.kt](file://app/src/main/java/com/example/phonenet/FirewallVpnService.kt#L319-L359)

## 忽略电池优化设置

为确保应用在后台稳定运行，建议用户在系统设置中将应用设置为“忽略电池优化”。现代Android系统为了延长电池续航，会对后台应用进行严格的限制，可能导致应用被系统杀死或暂停运行。

应用提供了“忽略电池优化”按钮，点击后会尝试引导用户到相应的系统设置页面。在`MainActivity.kt`中，`requestIgnoreBatteryOptimizations()`方法实现了这一功能。该方法首先检查当前是否已忽略电池优化，若未忽略，则尝试通过标准Intent打开系统设置页面。

由于不同手机厂商的系统定制化程度较高，该方法还包含了针对主流厂商（如小米、华为、OPPO、vivo等）的特定设置页面跳转逻辑。如果标准方法无法打开设置，应用会尝试这些厂商特定的Activity。

用户也可以手动在系统设置中找到电池优化选项，并将本应用设置为“不优化”或“允许后台运行”，以确保服务的稳定性。

**Section sources**
- [MainActivity.kt](file://app/src/main/java/com/example/phonenet/MainActivity.kt#L294-L486)

## 查询所有应用权限

应用使用`QUERY_ALL_PACKAGES`权限来扫描设备上所有可选的应用列表，以便用户在白名单中选择允许联网的应用。然而，在当前实现中，该权限已被移除，改用`<queries>`标签声明所需的应用可见性。

在`AndroidManifest.xml`中，通过`<queries>`标签声明了需要查询的应用类型。具体而言，应用只查询具有`MAIN`动作和`LAUNCHER`类别的应用，即那些在桌面显示图标的可启动应用。这种方式更加安全和隐私友好，避免了过度请求权限。

这种方法符合Google Play的政策要求，同时也能满足应用的功能需求。通过这种方式，应用可以获取到所有可启动应用的列表，并在设置页面的白名单中展示给用户选择。

**Section sources**
- [AndroidManifest.xml](file://app/src/main/AndroidManifest.xml#L1-L27)
- [SettingsActivity.kt](file://app/src/main/java/com/example/phonenet/SettingsActivity.kt#L183-L210)

## SMTP测试邮件配置

应用支持配置SMTP邮件服务器，用于发送测试邮件以验证配置的有效性。用户可以在设置页面填写邮箱账号、密码、SMTP服务器地址和端口等信息。

在`SettingsActivity.kt`中，`sendTestEmail()`方法负责发送测试邮件。该方法首先检查家长邮箱是否已填写，然后调用`MailJobIntentService.enqueue()`方法发送邮件。若发送失败，会提示用户检查配置。

`MailJobIntentService.kt`中的`onHandleWork()`方法处理邮件发送的具体逻辑。该方法从应用偏好设置中读取SMTP配置，包括主机、端口、SSL/TLS设置、用户名、密码和发件人地址。若任何必要字段为空，方法将直接返回，不进行发送尝试。

常见的配置失败原因包括：
- 邮箱账号或密码错误
- SMTP服务器地址或端口设置不正确
- 未正确启用SSL或TLS加密
- 发件人地址与登录账号不匹配

用户应确保所有配置项正确无误，并注意SSL和TLS的端口差异（SSL默认465，TLS默认587）。应用内设置与系统权限需同时满足才能正常工作。

**Section sources**
- [SettingsActivity.kt](file://app/src/main/java/com/example/phonenet/SettingsActivity.kt#L212-L234)
- [MailJobIntentService.kt](file://app/src/main/java/com/example/phonenet/mail/MailJobIntentService.kt#L28-L91)
- [strings.xml](file://app/src/main/res/values/strings.xml#L23-L31)